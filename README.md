
## Сглаживание DAU

*DAU (Daily Active Users)*
— это количество уникальных пользователей за сутки. Стабильно высокие показатели DAU говорят о том, что продукт интересен пользователям.
DAU целесообразно отслеживать на продуктах, которыми люди пользуются каждый день: игры, календари, электронная почта.
(почитать про DAU можно здесь https://www.unisender.com/ru/glossary/mau-dau-ili-osnovnye-metriki-mobilnyh-prilozhenij/)

### Оконные функции SQL: скользящие агрегаты
Дополнительная информация о скользящем среднем (https://antonz.ru/window-rolling/#rolling-avg)
Дополнительная информация о медианном сглаживании (https://studfile.net/preview/9931880/page:5/)

## Выполние запроса на основе задачи
Вам дана таблица `UserEntry` в которой фиксируется первый заход пользователя на платформу за текущий день.

Таблица `UserEntry` содержит:

- `id` - уникальный id каждого входа в формате int.
- `entry_at` - время входа пользователя в формате timestamp.
- `page_id` - id страницы, на которую зашел пользователь. Формат int.
- `user_id` - id пользователя в формате int.

#### Ваша задача:

 * Посчитать DAU за каждый день 2022 года на основании заходов пользователей на платформу 
 * Сделать столбец, где значения DAU будут сглажены с помощью метода скользящего среднего 
 * Сделать столбец, где значения DAU будут сглажены с помощью метода медианного сглаживания

#### В результате должны получиться столбцы:

- `ymd` - столбец с днем (в текстовом формате)
- `cnt` - значение DAU
- `sliding_average` - сглаживание средним
- `sliding_median` - сглаживание медианой

*Примечание:* При сглаживании берем все значения DAU за предыдущие даты. Текущую дату также включаем.

*Примечание:* При расчете медианы рассчитанное значение не обязано входить в исходный набор данных.

```sql
WITH DailyActiveUsers AS (
    SELECT
        to_char(entry_at, 'YYYY-MM-DD') AS ymd,
        COUNT(DISTINCT user_id) AS cnt
    FROM
        UserEntry
    WHERE
        entry_at >= '2022-01-01' AND entry_at < '2023-01-01'
    GROUP BY
        to_char(entry_at, 'YYYY-MM-DD')
),
SlidingAverages AS (
    SELECT
        ymd,
        cnt,
        AVG(cnt) OVER (ORDER BY ymd ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS sliding_average
    FROM
        DailyActiveUsers
),
SlidingMedians AS (
    SELECT
        ymd,
        cnt,
        sliding_average,
        (SELECT PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY cnt) 
         FROM (SELECT cnt 
               FROM SlidingAverages 
               WHERE ymd <= sa.ymd) AS subquery) AS sliding_median
    FROM
        SlidingAverages sa
)
SELECT
    ymd,
    cnt,
    sliding_average,
    sliding_median
FROM
    SlidingMedians
ORDER BY
    ymd;
```

**Разбор этого SQL запроса**
### 1. WITH

Ключевое слово WITH используется для создания временных именованных подзапросов, которые можно использовать в основном запросе. Это похоже на создание временных таблиц, которые существуют только в рамках данного запроса. Это может помочь сделать запрос более организованным и читаемым.

### 2. to_char

Функция to_char используется для преобразования даты или времени в строку в заданном формате. В данном случае to_char(entry_at, 'YYYY-MM-DD') преобразует дату и время входа пользователя (entry_at) в строку формата "ГГГГ-ММ-ДД", что удобно для группировки по дням.

### 3. OVER (ORDER BY ymd ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)

Эта конструкция используется в аналитических функциях для определения набора строк, по которому будет выполняться вычисление.

- OVER: Указывает, что за ним следует аналитическая функция.
- ORDER BY ymd: Определяет порядок строк, по которому будет проводиться вычисление. В данном случае строки упорядочиваются по дате (ymd).
- ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW: Определяет диапазон строк для вычисления функции. Здесь это значит, что функция будет применяться ко всем строкам от начала до текущей строки. Это важно для расчёта скользящего среднего, поскольку оно учитывает все предыдущие значения до текущей даты включительно.

### 4. PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY cnt)

Эта конструкция используется для вычисления процентиля, который представляет собой значение, ниже которого находится определенный процент данных. В данном случае:

- PERCENTILE_CONT(0.5): Вычисляет медиану (50-й процентиль — это такое значение, при котором 50% элементов набора данных равны или меньше этого значения.) для указанного набора данных.
- WITHIN GROUP (ORDER BY cnt): Указывает, как именно данные должны быть упорядочены перед вычислением процентиля. Здесь данные упорядочиваются по количеству уникальных пользователей (cnt) для каждой даты.

### Принцип построения запроса

1. Подзапрос DailyActiveUsers: Вычисляет количество уникальных пользователей (DAU) для каждого дня 2022 года и группирует данные по датам.

2. Подзапрос SlidingAverages: Использует результаты первого подзапроса для расчета скользящего среднего количества пользователей. Скользящее среднее вычисляется, включая все предыдущие дни вплоть до текущего.

3. Подзапрос SlidingMedians: Использует данные из второго подзапроса для вычисления медианного значения DAU, также включая все предыдущие дни.

4. Основной запрос: Извлекает данные из последнего подзапроса, выводя дату, количество уникальных пользователей, скользящее среднее и медиану.

